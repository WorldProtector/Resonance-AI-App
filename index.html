<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resonance AI | Coherence Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d121c;
            color: #e0e7ff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .app-container {
            width: 100%;
            max-width: 420px;
            background-color: #1a202c;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-height: 70vh;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            /* Desktop/Tablet Fix: Increase max-width and min-height for larger screens */
            @media (min-width: 640px) {
                max-width: 500px; /* Slightly wider on desktop */
                min-height: 80vh; 
            }
        }
        .screen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            animation: fadeIn 0.4s ease-out;
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .button-base {
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            text-align: center;
        }
        .goal-button {
            background-color: #2d3748;
            border: 2px solid #4a5568;
        }
        .goal-button:hover {
            background-color: #4a5568;
            border-color: #6366f1;
        }
        .goal-button.selected {
            background-color: #6366f1;
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
        .primary-button {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .primary-button:hover {
            background-color: #4f46e5;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6);
        }

        /* Scanning Animation Styles */
        .scan-visual {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 200px;
            margin: 2rem 0;
        }
        .scan-bar {
            width: 10%;
            background-color: #4a5568;
            border-radius: 5px;
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scaleY(0.1); background-color: #4a5568; }
            100% { transform: scaleY(1); background-color: #6366f1; }
        }

        /* Aura Meter SVG Styles */
        .aura-meter {
            transform: rotate(-90deg);
        }
        .aura-meter-track {
            stroke: #2d3748;
        }
        .aura-meter-fill {
            stroke: #6366f1;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-in-out;
        }
    </style>
</head>
<body>
<div class="app-container">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-[#6366f1]">Resonance AI</h1>
        <p class="text-sm text-gray-400">Bio-Acoustic Wellness Engine</p>
    </header>

    <!-- Screens will be dynamically loaded here -->
    <div id="screen-goal-selection" class="screen active">
        <h2 class="text-xl font-bold mb-4 text-center">Find Your State of Coherence</h2>
        <p class="text-center text-sm mb-6 text-gray-400">Your environment shapes your inner state. Select the foundational goal for today's acoustic analysis:</p>
        <div id="goal-buttons" class="space-y-4 mb-8">
            <button onclick="setGoal('Restorative Sleep')" class="button-base goal-button w-full" data-goal="Restorative Sleep">Restorative Sleep</button>
            <button onclick="setGoal('Deep Focus')" class="button-base goal-button w-full" data-goal="Deep Focus">Deep Focus</button>
            <button onclick="setGoal('Natural Calm')" class="button-base goal-button w-full" data-goal="Natural Calm">Natural Calm</button>
        </div>
        <button onclick="showScreen('reports')" class="button-base w-full text-sm text-gray-400 hover:text-white mt-auto">View Acoustic Health Reports</button>
    </div>

    <div id="screen-scanning" class="screen">
        <h2 class="text-xl font-bold mb-4 text-center">Acoustic Analysis in Progress...</h2>
        <p id="scanning-status" class="text-center text-sm text-gray-400 mb-6">Initializing Adaptive Resonance Sensor...</p>
        <div class="scan-visual">
            <div class="scan-bar" style="height: 50%;"></div>
            <div class="scan-bar" style="animation-delay: 0.1s; height: 75%;"></div>
            <div class="scan-bar" style="animation-delay: 0.2s; height: 30%;"></div>
            <div class="scan-bar" style="animation-delay: 0.3s; height: 90%;"></div>
            <div class="scan-bar" style="animation-delay: 0.4s; height: 60%;"></div>
            <div class="scan-bar" style="animation-delay: 0.5s; height: 45%;"></div>
        </div>
        <p class="text-xs text-center text-gray-500 mt-auto">Do not interrupt the bio-acoustic data collection.</p>
    </div>

    <div id="screen-results" class="screen">
        <h2 class="text-xl font-bold mb-4 text-center text-red-400">Diagnosis: Disrupted Theta Flow Detected.</h2>
        <div class="flex flex-col items-center my-6">
            <!-- Aura Meter SVG will be rendered here -->
            <svg id="aura-meter-svg" width="150" height="150" viewBox="0 0 120 120" class="aura-meter">
                <circle cx="60" cy="60" r="54" fill="none" stroke-width="12" class="aura-meter-track"></circle>
                <circle cx="60" cy="60" r="54" fill="none" stroke-width="12" class="aura-meter-fill"></circle>
            </svg>
            <div class="absolute flex flex-col items-center justify-center h-[150px]">
                <p class="text-4xl font-extrabold text-white" id="stress-score-display"></p>
                <p class="text-sm text-gray-400">Stress Score</p>
            </div>
        </div>

        <div id="diagnosis-text-area" class="text-sm bg-gray-700/50 p-4 rounded-lg mb-6">
            <p class="mb-2 text-gray-300"><strong class="text-red-300">Analysis:</strong> Your current state reflects a deep disharmony.</p>
            <p id="disrupting-frequency" class="mb-2"></p>
            <p id="goal-summary"></p>
        </div>

        <button onclick="shareScore()" class="button-base primary-button w-full mb-4 bg-purple-600 hover:bg-purple-700">
            Share My Coherence State
        </button>

        <button onclick="playBinauralDemo()" id="binaural-demo-button" class="button-base w-full bg-indigo-600 hover:bg-indigo-700 text-white mb-4">
            Experience Coherence State (Free Demo)
        </button>

        <button onclick="showPaywall()" class="button-base primary-button w-full mt-2">
            Restore Your Natural Cohesion (Unlock Engine)
        </button>
    </div>

    <div id="screen-paywall" class="screen">
        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-400">Adaptive Resonance Engine</h2>
        <p class="text-center text-sm text-gray-400 mb-6">The only way to achieve consistent neurological cohesion.</p>
        <div class="bg-gray-700/50 p-4 rounded-lg mb-6">
            <p class="text-lg font-semibold text-white mb-2">Engine Features:</p>
            <ul class="text-sm space-y-2 text-gray-300 list-disc pl-5">
                <li>Dynamic, Real-time Frequency Neutralization.</li>
                <li>Personalized Delta/Theta Wave Synthesis.</li>
                <li>Long-Term Acoustic Health Trend Mapping.</li>
            </ul>
        </div>

        <p class="text-center text-xl font-bold mb-6 text-green-400">$7.99 / Month</p>

        <button onclick="subscribe()" class="button-base primary-button w-full mb-4">Subscribe Now (Simulated)</button>
        <!-- Updated to Free Demo button -->
        <button onclick="showSimulatedFixDemo()" class="button-base w-full text-sm text-gray-400 hover:text-white">Free Engine Demo</button>
    </div>

    <div id="screen-reports" class="screen">
        <h2 class="text-xl font-bold mb-6 text-center">Acoustic Health Reports</h2>
        <div id="reports-list" class="space-y-4 overflow-y-auto flex-grow mb-6">
            <p class="text-center text-gray-500">Loading reports...</p>
        </div>
        <button onclick="showScreen('goal-selection')" class="button-base w-full text-sm text-gray-400 hover:text-white mt-auto">‚Üê Back to Goals</button>
    </div>

    <!-- Simulated Demo Modal -->
    <div id="simulated-fix-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 p-8 rounded-xl shadow-2xl text-center border-2 border-green-500">
            <h3 class="text-2xl font-bold text-green-400 mb-4">Frequency Neutralization Demo</h3>
            <p class="text-gray-300 mb-6">Simulating the Adaptive Resonance Engine at work...</p>
            <div class="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
    </div>
</div>

<script type="module">
    // --- Firebase Imports and Initialization ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: YOUR SECURE PRODUCTION CONFIGURATION (API Key is here)
    const firebaseConfig = {
      apiKey: "AIzaSyQCWdCqHjyzoDqHf7NSTLa_N1AQxzQW2Y",
      authDomain: "resonance-ai-prod-44a3d.firebaseapp.com",
      projectId: "resonance-ai-prod-44a3d",
      storageBucket: "resonance-ai-prod-44a3d.appspot.com",
      messagingSenderId: "102779965339",
      appId: "1:102779965339:web:f6436540059b23ae96bb3e",
      measurementId: "G-NVNT72Z3XT"
    };
    const APP_ID = "resonance-ai-prod-44a3d";

    setLogLevel('debug');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUserId = null;
    let isAuthReady = false;

    // --- Core Functions Exposed Globally ---
    
    // We define functions inside the module script and attach them to the global window object.
    // This allows the HTML 'onclick' attributes to find them.

    window.saveReport = async (score, goal, diagnosis, disruptingFrequency) => {
        if (!isAuthReady || !currentUserId) {
            console.error("Auth not ready. Cannot save report.");
            return;
        }
        try {
            const reportsCollectionRef = collection(db, `artifacts/${APP_ID}/users/${currentUserId}/acoustic_reports`);
            await addDoc(reportsCollectionRef, {
                score: score,
                goal: goal,
                diagnosis: diagnosis,
                disruptingFrequency: disruptingFrequency,
                timestamp: new Date().toISOString()
            });
            console.log("Report successfully saved to Firestore.");
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    };

    window.loadReports = () => {
        const reportsList = document.getElementById('reports-list');
        reportsList.innerHTML = '<p class="text-center text-gray-500">Loading reports...</p>';

        if (!isAuthReady || !currentUserId) {
            reportsList.innerHTML = '<p class="text-center text-red-400">User not authenticated. Please wait for Firebase sign-in.</p>';
            return;
        }

        try {
            const reportsCollectionRef = collection(db, `artifacts/${APP_ID}/users/${currentUserId}/acoustic_reports`);
            
            // Listen for real-time updates (onSnapshot)
            onSnapshot(reportsCollectionRef, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    reports.push({ ...data, id: doc.id });
                });

                // Sort reports in memory by timestamp (newest first)
                reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (reports.length === 0) {
                    reportsList.innerHTML = `<p class="text-center text-gray-500">No reports found for User ID: <code class="text-xs">${currentUserId}</code></p>`;
                    return;
                }

                reportsList.innerHTML = `<p class="text-xs text-center text-gray-500 mb-4">User ID: ${currentUserId}</p>`;
                reports.forEach(report => {
                    const date = new Date(report.timestamp).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    reportsList.innerHTML += `
                        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                            <p class="font-semibold text-indigo-300">${report.goal} Scan (${date})</p>
                            <p class="text-lg font-extrabold text-red-400">Score: ${report.score}/100</p>
                            <p class="text-sm text-gray-400">${report.diagnosis}</p>
                        </div>
                    `;
                });
            }, (error) => {
                console.error("Error loading reports: ", error);
                reportsList.innerHTML = '<p class="text-center text-red-400">Error loading reports. Check console.</p>';
            });
        } catch (e) {
            console.error("Firestore setup error: ", e);
            reportsList.innerHTML = '<p class="text-center text-red-400">Database setup failed. Check console.</p>';
        }
    };

    // --- Firebase Auth Initialization ---
    signInAnonymously(auth)
        .then((userCredential) => {
            currentUserId = userCredential.user.uid;
            isAuthReady = true;
            console.log("Firebase initialized. User ID:", currentUserId);
        })
        .catch((error) => {
            console.error("Firebase Auth Error:", error);
            // If anonymous sign-in fails, use a random ID for simulation purposes
            currentUserId = crypto.randomUUID();
            isAuthReady = true;
        });

</script>

<!-- The second script block contains the main game/UI logic, now using simple function calls -->
<script>
    let selectedGoal = null;
    let stressScore = 0;
    let disruptingFrequency = '';
    let diagnosisMessage = '';
    let binauralSynth = null;
    let scanInterval;

    // --- UI/Screen Functions ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(`screen-${screenId}`).classList.add('active');

        if (screenId === 'reports' && window.loadReports) {
            window.loadReports();
        }
        if (screenId !== 'results' && binauralSynth) {
            stopBinauralDemo();
        }
    }

    window.setGoal = (goal) => {
        selectedGoal = goal;
        document.querySelectorAll('.goal-button').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.getAttribute('data-goal') === goal) {
                btn.classList.add('selected');
            }
        });
        startScan();
    }

    function startScan() {
        if (!selectedGoal) return;
        showScreen('scanning');
        const statusElement = document.getElementById('scanning-status');

        const statusUpdates = [
            "Initializing Adaptive Resonance Sensor...",
            "Performing Bio-Acoustic FFT Analysis...",
            "Identifying Sub-Hertz Disruptive Frequencies...",
            "Mapping Environmental Noise to Theta Flow...",
            "Calculating Neurological Cohesion Score..."
        ];
        let updateIndex = 0;

        // Clear any existing interval just in case
        if (scanInterval) clearInterval(scanInterval);

        scanInterval = setInterval(() => {
            if (updateIndex < statusUpdates.length) {
                statusElement.textContent = statusUpdates[updateIndex];
                updateIndex++;
            } else {
                clearInterval(scanInterval);
                setTimeout(showResults, 1000);
            }
        }, 1000);
    }

    function showResults() {
        // --- 1. DSP Simulation & Diagnosis ---
        stressScore = Math.floor(Math.random() * (95 - 65 + 1)) + 65; // High score range: 65-95
        const lowHz = Math.floor(Math.random() * (20 - 5 + 1)) + 5; 
        const highHz = Math.floor(Math.random() * (200 - 100 + 1)) + 100;

        disruptingFrequency = `${stressScore % 2 === 0 ? lowHz : highHz}Hz`;

        let goalSummary = '';
        let toneFrequency = 0; 

        switch (selectedGoal) {
            case 'Restorative Sleep':
                diagnosisMessage = 'Disrupted Delta Wave Cohesion.';
                toneFrequency = 2 + (stressScore % 3); 
                goalSummary = `Resulting in fragmented sleep cycles and chronic daytime fatigue.`;
                break;
            case 'Deep Focus':
                diagnosisMessage = 'High Beta Wave Interference Detected.';
                toneFrequency = 15 + (stressScore % 5);
                goalSummary = `Resulting in productivity loss and difficulty sustaining attention.`;
                break;
            case 'Natural Calm':
                diagnosisMessage = 'Exaggerated Gamma/Theta Dissonance.';
                toneFrequency = 7 + (stressScore % 3); 
                goalSummary = `Resulting in persistent restlessness and elevated internal stress.`;
                break;
        }

        // --- 2. Update UI ---
        document.getElementById('screen-results').querySelector('h2').textContent = `Diagnosis: ${diagnosisMessage}`;
        document.getElementById('stress-score-display').textContent = stressScore;
        document.getElementById('disrupting-frequency').innerHTML = `<strong class="text-red-300">Stress Source:</strong> Dominant frequency spike detected at ${disruptingFrequency}.`;
        document.getElementById('goal-summary').textContent = goalSummary;

        // --- 3. Update Aura Meter ---
        const radius = 54;
        const circumference = 2 * Math.PI * radius;
        const dashoffset = circumference - (stressScore / 100) * circumference;

        const fillCircle = document.querySelector('.aura-meter-fill');
        fillCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        fillCircle.style.strokeDashoffset = dashoffset;
        
        if (stressScore > 80) {
            fillCircle.style.stroke = '#f87171'; // Red
        } else if (stressScore > 70) {
            fillCircle.style.stroke = '#fbbf24'; // Yellow
        } else {
            fillCircle.style.stroke = '#4ade80'; // Green
        }

        // --- 4. Save to Firestore (uses the globally exposed function) ---
        if (window.saveReport) {
            window.saveReport(stressScore, selectedGoal, diagnosisMessage, disruptingFrequency);
        } else {
            console.error("window.saveReport is not yet available.");
        }

        showScreen('results');
    }

    function shareScore() {
        const message = `üö® My Resonance AI Scan showed a ${stressScore}/100 Environmental Stress Score due to ${disruptingFrequency} interference. I need to Restore My Natural Cohesion with the Adaptive Resonance Engine! #ResonanceAI #AcousticWellness`;
        
        const tempInput = document.createElement('textarea');
        tempInput.value = message;
        document.body.appendChild(tempInput);
        tempInput.select();
        
        try {
            document.execCommand('copy');
            // Use a custom UI alert instead of native alert()
            showCustomAlert("Score copied to clipboard! Share the dissonance.");
        } catch (err) {
            console.error('Could not copy text: ', err);
            showCustomAlert("Could not copy. Please manually copy this text:\n" + message);
        }
        document.body.removeChild(tempInput);
    }

    function showPaywall() {
        stopBinauralDemo();
        showScreen('paywall');
    }

    function subscribe() {
        // --- Simulated Subscription Success ---
        showCustomAlert("Thank you for subscribing! Your Adaptive Resonance Engine is now active. (Payment simulated)");
        // After "subscribing," trigger the fix demo and reset the app.
        showSimulatedFixDemo();
    }

    // Renamed and adjusted logic
    function closePaywallAndReset() { 
        showSimulatedFixDemo();
    }

    function showSimulatedFixDemo() {
        const modal = document.getElementById('simulated-fix-modal');
        
        showScreen('scanning');
        document.getElementById('scanning-status').textContent = "Adaptive Resonance Engine: Frequency Neutralization Active. (Simulated)";
        modal.classList.remove('hidden');

        document.querySelectorAll('.scan-bar').forEach(bar => {
            bar.style.backgroundColor = '#10b981'; 
            bar.style.animationDuration = '2.5s'; 
        });

        setTimeout(() => {
            modal.classList.add('hidden');
            
            document.querySelectorAll('.scan-bar').forEach(bar => {
                bar.style.backgroundColor = ''; 
                bar.style.animationDuration = ''; 
            });
            
            resetApp();
        }, 3000);
    }

    function resetApp() {
        selectedGoal = null;
        stressScore = 0;
        document.querySelectorAll('.goal-button').forEach(btn => btn.classList.remove('selected'));
        showScreen('goal-selection');
    }

    // --- Binaural Audio Logic ---
    function playBinauralDemo() {
        const btn = document.getElementById('binaural-demo-button');
        if (binauralSynth) {
            stopBinauralDemo();
            return;
        }
        
        // This is necessary to resume audio context after a user interaction
        Tone.start().then(async () => {
            btn.textContent = 'Generating Coherence Frequency...';
            btn.disabled = true;

            let baseTone = 0;
            let beatFrequency = 0;

            const freqValue = parseFloat(disruptingFrequency.replace('Hz', '')) || 100; // Fallback to 100Hz

            if (selectedGoal === 'Restorative Sleep') {
                beatFrequency = 2; // Delta wave
                baseTone = 100 + freqValue;
            } else if (selectedGoal === 'Deep Focus') {
                beatFrequency = 18; // High Beta wave
                baseTone = 200 + freqValue; 
            } else {
                beatFrequency = 8; // Alpha wave
                baseTone = 150 + freqValue;
            }

            const freq1 = baseTone + beatFrequency / 2;
            const freq2 = baseTone - beatFrequency / 2;

            try {
                binauralSynth = new Tone.PolySynth(Tone.AMSynth, {
                    volume: -10,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.5, decay: 0.1, sustain: 1, release: 2 }
                }).toDestination();

                binauralSynth.triggerAttack([freq1, freq2]);

                btn.textContent = 'Stop Coherence Frequency';
                btn.classList.remove('bg-indigo-600');
                btn.classList.add('bg-red-500');
                btn.disabled = false;

            } catch (error) {
                console.error("Tone.js Audio Error:", error);
                showCustomAlert("Could not start audio demo. Check console for details.");
                btn.textContent = 'Audio Failed';
                btn.disabled = false;
            }
        });
    }

    function stopBinauralDemo() {
        if (binauralSynth) {
            binauralSynth.releaseAll();
            binauralSynth = null;
        }
        const btn = document.getElementById('binaural-demo-button');
        btn.textContent = 'Experience Coherence State (Free Demo)';
        btn.classList.add('bg-indigo-600');
        btn.classList.remove('bg-red-500');
        btn.disabled = false;
    }

    // --- Custom Alert/Modal Replacement ---
    function showCustomAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[9999]';
        alertDiv.innerHTML = `
            <div class="bg-gray-900 p-6 rounded-xl shadow-2xl text-center border-2 border-indigo-500 max-w-xs">
                <p class="text-white mb-4">${message}</p>
                <button class="button-base primary-button w-full" onclick="this.closest('.fixed').remove()">OK</button>
            </div>
        `;
        document.body.appendChild(alertDiv);
    }
</script>

</body>
</html>
